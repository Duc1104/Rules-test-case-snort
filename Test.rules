# ==============================================
# Rules test Lab IDS
# ==============================================

# TC-LAN-001 Port Scan (TCP SYN + ICMP)
alert tcp any any -> $HOME_NET any (msg:"[LOCAL] Port Scan TCP SYN Detected"; flow:stateless; flags:S,12; threshold:type both, track by_dst, count 50, seconds 10; sid:9000001; rev:1;)
alert icmp any any -> $HOME_NET any (msg:"[LOCAL] ICMP Sweep / Port Scan"; itype:8; threshold:type both, track by_dst, count 30, seconds 10; sid:9000002; rev:1;)

# TC-LAN-002 TCP SYN Flood
alert tcp any any -> $HOME_NET any (msg:"[LOCAL] TCP SYN Flood Detected"; flow:stateless; flags:S; threshold:type threshold, track by_dst, count 200, seconds 5; sid:9000003; rev:1;)

# TC-LAN-003 ICMP Flood
alert icmp any any -> $HOME_NET any (msg:"[LOCAL] ICMP Flood Detected"; itype:8; threshold:type threshold, track by_dst, count 500, seconds 5; sid:9000004; rev:1;)

# TC-LAN-004 EternalBlue MS17-010
alert tcp any any -> $HOME_NET 445 (msg:"[LOCAL] EternalBlue MS17-010 Attempt"; flow:to_server,established; content:"|FF|SMB%"; depth:5; content:"|00 05 00|"; distance:3; within:3; byte_test:1,=,0,0,relative; content:"|2a 00 00|"; distance:30; within:3; reference:cve,2017-0144; sid:9000005; rev:2;)

# TC-LAN-005 Brute-force SSH (nhiều kết nối thất bại)
alert tcp any any -> $HOME_NET 22 (msg:"[LOCAL] SSH Brute-Force Detected"; flow:to_server; content:"SSH-"; depth:4; threshold:type threshold, track by_src, count 10, seconds 60; sid:9000006; rev:1;)

# TC-LAN-006 Meterpreter C2 Beaconing (User-Agent đặc trưng)
alert tcp $HOME_NET any -> any any (msg:"[LOCAL] Meterpreter Reverse TCP Beacon"; flow:established,to_server; content:"POST"; http_method; content:"User-Agent|3a| Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)"; depth:60; pcre:"/User-Agent\x3a[^\r\n]{0,100}Meterpreter/i"; sid:9000007; rev:2;)

# TC-LAN-007 DNS Tunneling (iodine, dncat – nhiều TXT query dài)
alert udp any any -> any 53 (msg:"[LOCAL] Possible DNS Tunneling (Long TXT)"; dns_query; pcre:"/^.+\.tunnel\.lab$/i"; content:"|00 00 ff 00 01|"; offset:2; depth:5; byte_test:2,>,200,0,relative,dce; threshold:type both, track by_src, count 10, seconds 300; sid:9000008; rev:1;)

# TC-LAN-009 RDP Brute-force
alert tcp any any -> $HOME_NET 3389 (msg:"[LOCAL] RDP Brute-Force Detected"; flow:to_server,established; threshold:type threshold, track by_src, count 15, seconds 120; sid:9000009; rev:1;)

# TC-LAN-010 ARP Poisoning (nhiều ARP reply từ 1 MAC)
alert arp any any -> any any (msg:"[LOCAL] ARP Spoofing / MITM Detected"; arpop:2; threshold:type both, track by_src, count 20, seconds 10; sid:9000010; rev:1;)

# TC-LAN-011 Data Exfiltration (lưu lượng outbound cực lớn)
alert tcp $HOME_NET any -> !$HOME_NET any (msg:"[LOCAL] Possible Data Exfiltration (>500MB outbound)"; flow:established,to_server; threshold:type threshold, track by_src, bytes 524288000, seconds 600; sid:9000011; rev:1;)

# TC-WEB-001 SQL Injection
alert tcp any any -> $HTTP_SERVERS $HTTP_PORTS (msg:"[LOCAL] SQL Injection Attempt"; flow:to_server,established; http_uri; pcre:"/(\%27|\'|--|;|union|select|insert|update|delete|drop|cast|convert|char|substr|exec|execute|benchmark|sleep)\s/i"; content:"|27 20 61 6e 64 20|"; nocase; sid:9000101; rev:3;)

# TC-WEB-002 Directory Traversal
alert tcp any any -> $HTTP_SERVERS $HTTP_PORTS (msg:"[LOCAL] Directory Traversal Attempt"; flow:to_server,established; http_uri; content:"../"; nocase; pcre:"/(\.\.\/){4,}|(%2e%2e%2f){4,}/i"; sid:9000102; rev:2;)

# TC-WEB-003 Command Injection
alert tcp any any -> $HTTP_SERVERS $HTTP_PORTS (msg:"[LOCAL] Command Injection Attempt"; flow:to_server,established; http_uri; http_client_body; pcre:"/(\b(curl|wget|nc|ncat|bash|sh|perl|python|php|-c|-e|;|\||&|\|&|\$\(|\`))/i"; sid:9000103; rev:3;)

# TC-WEB-004 XSS Reflected / Stored
alert tcp any any -> $HTTP_SERVERS $HTTP_PORTS (msg:"[LOCAL] XSS Attempt"; flow:to_server,established; http_uri; http_client_body; pcre:"/(<script>|<img\s+onerror=|<svg onload=|\bon\w+\s*=)/i"; sid:9000104; rev:2;)

# TC-WEB-005 File Upload Webshell
alert tcp any any -> $HTTP_SERVERS $HTTP_PORTS (msg:"[LOCAL] Webshell Upload Attempt"; flow:to_server,established; http_header; content:"Content-Type|3a| multipart/form-data"; http_client_body; content:".php" ; nocase; pcre:"/(\.php[\x00\x20-\x2e]|\.php\x00|\.php$)/i"; sid:9000105; rev:2;)

# TC-WEB-006 SSRF Attempt
alert tcp any any -> $HTTP_SERVERS $HTTP_PORTS (msg:"[LOCAL] SSRF Attempt (Internal IPs)"; flow:to_server,established; http_uri; http_client_body; pcre:"/(\b(127\.0\.0\.1|localhost|169\.254\.169\.254|192\.168\.|10\.|172\.(1[6-9]|2[0-9]|3[0-1])\.))/i"; sid:9000106; rev:1;)

# TC-WEB-007 XXE Attempt
alert tcp any any -> $HTTP_SERVERS $HTTP_PORTS (msg:"[LOCAL] XXE Attempt"; flow:to_server,established; content:"<!DOCTYPE" ; http_client_body; content:"<!ENTITY" ; distance:0; content:"SYSTEM" ; distance:0; content:"file://" ; within:200; sid:9000107; rev:1;)

# TC-WEB-008 Insecure Deserialization (PHP Object Injection)
alert tcp any any -> $HTTP_SERVERS $HTTP_PORTS (msg:"[LOCAL] PHP Object Injection / Deserialization"; flow:to_server,established; http_client_body; pcre:"/O\+?:\d+:/i"; content:"__wakeup" ; nocase; distance:0; sid:9000108; rev:1;)

# Reverse Shell in Command Injection
alert tcp any any -> $HTTP_SERVERS $HTTP_PORTS (msg:"[LOCAL] Reverse Shell Attempt (bash -i >& /dev/tcp/)"; flow:to_server,established; http_client_body; pcre:"/bash\s+-i.+dev.tcp/i"; sid:9000109; rev:1;)

# TC-EV-001 Nmap SYN Scan + Fragmentation
alert tcp any any -> $HOME_NET any (msg:"SCAN Nmap SYN Fragmented"; flags:S; fragbits:M; detection_filter:track by_src, count 5, seconds 10; sid:200001; rev:1;)

# TC-EV-001 Nmap UDP Fragmented Scan
alert udp any any -> $HOME_NET any (msg:"SCAN Nmap UDP Fragmented"; fragbits:M; detection_filter:track by_src, count 5, seconds 10; sid:200002; rev:1;)

# TC-EV-002 Slowloris (Slow HTTP Headers DoS)
alert tcp any any -> $HOME_NET 80 (msg:"DOS Slowloris Attack – Slow HTTP Header Flood"; flow:to_server,established; content:"Host|3A|"; http_header; threshold:type both, track by_src, count 50, seconds 10; sid:200003; rev:1;)

# TC-EV-003 SQLi (space2comment)
alert tcp any any -> $HOME_NET 80 (msg:"WEB SQL Injection – space2comment evasion"; flow:to_server,established; content:"/**/"; http_uri; nocase; sid:200004; rev:1;)

# TC-EV-003 SQLi (randomcase)
alert tcp any any -> $HOME_NET 80 (msg:"WEB SQL Injection (randomcase)"; flow:to_server,established; pcre:"/(%27)|(')|(\-\-)|(%23)|(#)/i"; sid:200005; rev:1;)

# TC-EV-004 Directory Traversal Double-Encoded
alert tcp any any -> $HOME_NET 80 (msg:"WEB Directory Traversal Double-Encoded"; flow:to_server,established; uricontent:"%2e%2e%2f"; nocase; sid:200006; rev:1;)

# TC-EV-004 Directory Traversal Unicode
alert tcp any any -> $HOME_NET 80 (msg:"WEB Directory Traversal – Unicode encoded"; flow:to_server,established; pcre:"/%(c0|c1)%/i"; sid:200007; rev:1;)

